// prisma/schema.prisma
// Adds Week.lockAt and ensures updatedAt has a default for backfilling existing rows.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Phase 1: local SQLite; can swap later
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------

enum Role {
  STAFF
  MANAGER
}

enum TimeBlock {
  MORNING
  AFTERNOON
  EVENING
}

// ---------- Models ----------

model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  role  Role    @default(STAFF)

  availabilities Availability[]

  createdAt DateTime @default(now())
  // IMPORTANT: provide a default so adding this column to existing rows succeeds
  updatedAt DateTime @default(now()) @updatedAt
}

model Week {
  id String @id @default(cuid())

  /// Start of the scheduling week (Monday at 00:00 local). Unique per week.
  startMonday DateTime @unique

  /// When edits become locked for staff. Null = unlocked.
  lockAt DateTime?

  availabilities Availability[]

  createdAt DateTime @default(now())
  // IMPORTANT: provide a default so adding this column to existing rows succeeds
  updatedAt DateTime @default(now()) @updatedAt
}

model Availability {
  id String @id @default(cuid())

  userId String
  weekId String

  /// Which time block in the day this record represents.
  blockId TimeBlock

  /// 0..6 for Mon..Sun
  dayIndex Int

  /// Whether the user is available for this cell.
  available Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  week Week @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@unique([userId, weekId, blockId, dayIndex])
  @@index([weekId])
  @@index([userId])
}
